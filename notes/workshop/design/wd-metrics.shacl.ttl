@prefix wd:   <https://paperhat.dev/ns/wd#> .
@prefix wdm:  <https://paperhat.dev/ns/wdm#> .
@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# MetricSet well-formedness
#####################################################################

wdm:MetricSetShape a sh:NodeShape ;
  sh:targetClass wdm:MetricSet ;

  sh:property [
    sh:path wdm:forComposition ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Composition ;
  ] ;

  sh:property [
    sh:path wdm:forView ;
    sh:maxCount 1 ;
    sh:class wd:View ;
  ] ;

  sh:property [
    sh:path wdm:hasMetric ;
    sh:minCount 1 ;
    sh:class wdm:MetricAssertion ;
  ] ;

  sh:property [
    sh:path wdm:algorithmId ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
  ] ;

  sh:property [
    sh:path wdm:inputsHash ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
    sh:pattern "^[0-9a-f]{64}$" ;
  ] ;

  sh:property [
    sh:path wdm:computedAtEpochMs ;
    sh:maxCount 1 ;
    sh:datatype xsd:long ;
  ] .

#####################################################################
# MetricAssertion well-formedness
#####################################################################

wdm:MetricAssertionShape a sh:NodeShape ;
  sh:targetClass wdm:MetricAssertion ;

  sh:property [
    sh:path wdm:metricType ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wdm:MetricType ;
    sh:in (
      wdm:SalienceScore
      wdm:HierarchyRank
      wdm:ReadingOrderIndex
      wdm:BalanceDeviation
      wdm:SymmetryScore
      wdm:ContrastLuminance
      wdm:FigureGroundSeparation
      wdm:WhitespaceRatio
      wdm:AlignmentError
      wdm:GridConformanceScore
      wdm:TypographicRhythmScore
    ) ;
  ] ;

  sh:property [
    sh:path wdm:about ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
    sh:or (
      [ sh:class wd:ElementInstance ]
      [ sh:class wd:Region ]
      [ sh:class wd:Composition ]
      [ sh:class wd:PrincipleStatement ]
    ) ;
  ] ;

  sh:property [
    sh:path wdm:method ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wdm:MeasurementMethod ;
    sh:in (
      wdm:ComputedFromGeometryAndStyle
      wdm:ComputedFromGridModel
      wdm:ComputedFromTextMetrics
    ) ;
  ] ;

  sh:property [
    sh:path wdm:unit ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wdm:Unit ;
    sh:in (
      wdm:Unitless
      wdm:Percent
      wdm:Pixels
      wdm:CanvasUnits
    ) ;
  ] ;

  # Exactly one of valueDecimal or valueInteger
  sh:xone (
    [ sh:property [ sh:path wdm:valueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path wdm:valueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
  ) .
