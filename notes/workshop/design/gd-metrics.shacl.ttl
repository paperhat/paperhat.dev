@prefix gd:   <https://paperhat.dev/ns/gd#> .
@prefix gdm:  <https://paperhat.dev/ns/gdm#> .
@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# MetricSet well-formedness
#####################################################################

gdm:MetricSetShape a sh:NodeShape ;
  sh:targetClass gdm:MetricSet ;

  sh:property [
    sh:path gdm:forComposition ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gd:Composition ;
  ] ;

  sh:property [
    sh:path gdm:forView ;
    sh:maxCount 1 ;
    sh:class gd:View ;
  ] ;

  sh:property [
    sh:path gdm:hasMetric ;
    sh:minCount 1 ;
    sh:class gdm:MetricAssertion ;
  ] ;

  sh:property [
    sh:path gdm:algorithmId ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
  ] ;

  sh:property [
    sh:path gdm:inputsHash ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
    sh:pattern "^[0-9a-f]{64}$" ;
  ] ;

  sh:property [
    sh:path gdm:computedAtEpochMs ;
    sh:maxCount 1 ;
    sh:datatype xsd:long ;
  ] .

#####################################################################
# MetricAssertion well-formedness
#####################################################################

gdm:MetricAssertionShape a sh:NodeShape ;
  sh:targetClass gdm:MetricAssertion ;

  sh:property [
    sh:path gdm:metricType ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gdm:MetricType ;
    sh:in (
      gdm:SalienceScore
      gdm:HierarchyRank
      gdm:ReadingOrderIndex
      gdm:BalanceDeviation
      gdm:SymmetryScore
      gdm:ContrastLuminance
      gdm:FigureGroundSeparation
      gdm:WhitespaceRatio
      gdm:AlignmentError
      gdm:GridConformanceScore
      gdm:TypographicRhythmScore
    ) ;
  ] ;

  sh:property [
    sh:path gdm:about ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
    sh:or (
      [ sh:class gd:ElementInstance ]
      [ sh:class gd:Region ]
      [ sh:class gd:Composition ]
      [ sh:class gd:PrincipleStatement ]
    ) ;
  ] ;

  sh:property [
    sh:path gdm:method ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gdm:MeasurementMethod ;
    sh:in (
      gdm:ComputedFromGeometryAndStyle
      gdm:ComputedFromGridModel
      gdm:ComputedFromTextMetrics
    ) ;
  ] ;

  sh:property [
    sh:path gdm:unit ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gdm:Unit ;
    sh:in (
      gdm:Unitless
      gdm:Percent
      gdm:Pixels
      gdm:CanvasUnits
    ) ;
  ] ;

  # Exactly one of valueDecimal or valueInteger
  sh:xone (
    [ sh:property [ sh:path gdm:valueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path gdm:valueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
  ) .
