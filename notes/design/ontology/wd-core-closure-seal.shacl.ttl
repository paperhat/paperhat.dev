@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

#####################################################################
# wd-core-closure-seal.shacl.ttl
#
# Sealed Composition Graph Constraints (SHACL-SPARQL)
#
# Purpose:
# - enforce same-owner sealing for the full structural footprint of a
#   wd:Composition (closed-world, no cross-composition references)
# - enforce full reverse-reachability closure for every ownable structural
#   class using explicit structural-path constraints
#
# Notes:
# - Same-owner constraints require $this binding (SHACL-SPARQL).
# - Ownership-exactly-once constraints live in wd-core-closure.shacl.ttl.
#####################################################################

#####################################################################
# Composition sealing (same-owner invariants)
#####################################################################

wd:CompositionSealShape
  a sh:NodeShape ;
  sh:targetClass wd:Composition ;

  ###################################################################
  # hasCanvas: the Canvas referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "The wd:hasCanvas node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?c
      WHERE {
        $this wd:hasCanvas ?c .
        FILTER NOT EXISTS { ?c wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasElement: every ElementInstance referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasElement node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:hasElement ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.frame: every Rect referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:frame Rect referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:frame ?r .
        FILTER NOT EXISTS { ?r wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.style: every Style referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:style referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?s
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        FILTER NOT EXISTS { ?s wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.transform: every Transform referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:transform referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?t
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:transform ?t .
        FILTER NOT EXISTS { ?t wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.fill: every Paint referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:fill Paint referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:fill ?p .
        FILTER NOT EXISTS { ?p wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.stroke: every Stroke referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:stroke Stroke referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?k
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:stroke ?k .
        FILTER NOT EXISTS { ?k wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.typeStyle: every TypographicStyle referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:typeStyle TypographicStyle referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?ts
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:typeStyle ?ts .
        FILTER NOT EXISTS { ?ts wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasGrid: the GridSystem referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "If wd:hasGrid is present, the GridSystem must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        $this wd:hasGrid ?g .
        FILTER NOT EXISTS { ?g wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # grid.hasUnit: every GridUnit referenced by hasUnit must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasUnit GridUnit referenced by this Composition's GridSystem must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?u
      WHERE {
        $this wd:hasGrid ?g .
        ?g wd:hasUnit ?u .
        FILTER NOT EXISTS { ?u wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # grid.baselineGrid: if a GridSystem has baselineGrid, the BaselineGrid must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "If a GridSystem has wd:baselineGrid, the BaselineGrid must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?b
      WHERE {
        $this wd:hasGrid ?g .
        ?g wd:baselineGrid ?b .
        FILTER NOT EXISTS { ?b wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # expresses: every PrincipleStatement linked by expresses must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:expresses PrincipleStatement must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        $this wd:expresses ?p .
        FILTER NOT EXISTS { ?p wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # participant: every participant of an expressed PrincipleStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:participant in a PrincipleStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:expresses ?p .
        ?p wd:participant ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # foreground: every foreground element of an expressed FigureGroundStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:foreground element in a FigureGroundStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:expresses ?p .
        ?p a wd:FigureGroundStatement .
        ?p wd:foreground ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # background: every background value of an expressed FigureGroundStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:background value in a FigureGroundStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?x
      WHERE {
        $this wd:expresses ?p .
        ?p a wd:FigureGroundStatement .
        ?p wd:background ?x .
        FILTER NOT EXISTS { ?x wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # group: every GroupInstance referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:group GroupInstance referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:group ?g .
        FILTER NOT EXISTS { ?g wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasRegion: every Region referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasRegion node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        $this wd:hasRegion ?r .
        FILTER NOT EXISTS { ?r wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasLayer: every Layer referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasLayer node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        $this wd:hasLayer ?l .
        FILTER NOT EXISTS { ?l wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.layer: every Layer referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:layer referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:layer ?l .
        FILTER NOT EXISTS { ?l wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # member: every ElementInstance referenced by a GroupInstance reachable from this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:member referenced by a GroupInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?m
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:group ?g .
        ?g wd:member ?m .
        FILTER NOT EXISTS { ?m wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # Orphaned PrincipleStatements: no owned PrincipleStatement may exist that is not linked by expresses from its owning Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "No PrincipleStatement ownedBy this Composition may be orphaned (must be linked by wd:expresses)." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        ?p a wd:PrincipleStatement .
        ?p wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:expresses ?p . }
      }
    """ ;
  ] ;

  ###################################################################
  # Reverse reachability closure: every owned node class must be reachable
  # from its owning Composition through an allowed structural path.
  ###################################################################

  # Canvas
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Canvas must be reachable via wd:hasCanvas from its owning Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?c
      WHERE {
        ?c a wd:Canvas ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasCanvas ?c . }
      }
    """ ;
  ] ;

  # ElementInstance
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:ElementInstance must be reachable via wd:hasElement or via GroupInstance membership rooted at wd:hasElement." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        ?e a wd:ElementInstance ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasElement ?e . }
        FILTER NOT EXISTS {
          $this wd:hasElement ?root .
          ?root wd:group ?g .
          ?g wd:member ?e .
        }
      }
    """ ;
  ] ;

  # Rect
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Rect must be reachable via wd:frame from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        ?r a wd:Rect ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:frame ?r .
        }
      }
    """ ;
  ] ;

  # Style
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Style must be reachable via wd:style from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?s
      WHERE {
        ?s a wd:Style ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:style ?s .
        }
      }
    """ ;
  ] ;

  # Paint
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Paint must be reachable via wd:fill from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        ?p a wd:Paint ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:fill ?p .
        }
      }
    """ ;
  ] ;

  # Stroke
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Stroke must be reachable via wd:stroke from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?k
      WHERE {
        ?k a wd:Stroke ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:stroke ?k .
        }
      }
    """ ;
  ] ;

  # TypographicStyle
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:TypographicStyle must be reachable via wd:typeStyle from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?ts
      WHERE {
        ?ts a wd:TypographicStyle ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:typeStyle ?ts .
        }
      }
    """ ;
  ] ;

  # Transform
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Transform must be reachable via wd:transform from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?t
      WHERE {
        ?t a wd:Transform ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:transform ?t .
        }
      }
    """ ;
  ] ;

  # GroupInstance
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GroupInstance must be reachable via wd:group from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        ?g a wd:GroupInstance ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:group ?g .
        }
      }
    """ ;
  ] ;

  # GridSystem
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GridSystem must be reachable via wd:hasGrid from its owning Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        ?g a wd:GridSystem ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasGrid ?g . }
      }
    """ ;
  ] ;

  # GridUnit
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GridUnit must be reachable via wd:hasUnit from an owned wd:GridSystem." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?u
      WHERE {
        ?u a wd:GridUnit ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?g a wd:GridSystem ; wd:ownedBy $this ; wd:hasUnit ?u .
        }
      }
    """ ;
  ] ;

  # BaselineGrid
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:BaselineGrid must be reachable via wd:baselineGrid from an owned wd:GridSystem." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?b
      WHERE {
        ?b a wd:BaselineGrid ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?g a wd:GridSystem ; wd:ownedBy $this ; wd:baselineGrid ?b .
        }
      }
    """ ;
  ] ;

  # Region
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Region must be reachable via wd:hasRegion or as wd:background in an expressed wd:FigureGroundStatement." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        ?r a wd:Region ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasRegion ?r . }
        FILTER NOT EXISTS {
          $this wd:expresses ?p .
          ?p a wd:FigureGroundStatement .
          ?p wd:background ?r .
        }
      }
    """ ;
  ] ;

  # Layer
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Layer must be reachable via wd:hasLayer or via wd:layer from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        ?l a wd:Layer ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasLayer ?l . }
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:layer ?l .
        }
      }
    """ ;
  ] .

#####################################################################
# Owned node whitelist (enforceable closure boundary)
#####################################################################

wd:OwnedNodeClassWhitelistShape
  a sh:NodeShape ;
  sh:targetSubjectsOf wd:ownedBy ;

  sh:or (
    [ sh:class wd:ElementInstance ]
    [ sh:class wd:Rect ]
    [ sh:class wd:Style ]
    [ sh:class wd:Paint ]
    [ sh:class wd:Stroke ]
    [ sh:class wd:TypographicStyle ]
    [ sh:class wd:Transform ]
    [ sh:class wd:GroupInstance ]
    [ sh:class wd:GridSystem ]
    [ sh:class wd:GridUnit ]
    [ sh:class wd:BaselineGrid ]
    [ sh:class wd:PrincipleStatement ]
    [ sh:class wd:Region ]
    [ sh:class wd:Layer ]
    [ sh:class wd:Canvas ]
  ) .
