@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# wd-all.shacl.ttl
#
# Canonical SHACL validation bundle entrypoint for the Workshop
# design ontology core constraints.
#
# Generated from files listed in shacl-bundle-files.txt using
# scripts/build_shacl_bundle.sh.
#####################################################################


#####################################################################
# BEGIN wd-core.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# Composition
#####################################################################

wd:CompositionShape
  a sh:NodeShape ;
  sh:targetClass wd:Composition ;

  sh:property [
    sh:path wd:hasCanvas ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Canvas ;
  ] ;

  sh:property [
    sh:path wd:hasElement ;
    sh:minCount 1 ;
    sh:class wd:ElementInstance ;
  ] ;

  sh:property [
    sh:path wd:intent ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:CommunicativeIntent ;
  ] .

#####################################################################
# ElementInstance
#####################################################################

wd:ElementInstanceShape
  a sh:NodeShape ;
  sh:targetClass wd:ElementInstance ;

  sh:property [
    sh:path wd:instanceOf ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:ElementType ;
  ] ;

  sh:property [
    sh:path wd:frame ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Rect ;
  ] ;

  sh:property [
    sh:path wd:style ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Style ;
  ] ;

  sh:property [
    sh:path wd:semanticRole ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Role ;
  ] ;

  sh:property [
    sh:path wd:zIndex ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
  ] .

#####################################################################
# Rect
#####################################################################

wd:RectShape
  a sh:NodeShape ;
  sh:targetClass wd:Rect ;

  sh:property [
    sh:path wd:x ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
  ] ;

  sh:property [
    sh:path wd:y ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
  ] ;

  sh:property [
    sh:path wd:w ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minExclusive 0 ;
  ] ;

  sh:property [
    sh:path wd:h ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minExclusive 0 ;
  ] .

#####################################################################
# Style / Paint / Stroke / Typography
#####################################################################

wd:StyleShape
  a sh:NodeShape ;
  sh:targetClass wd:Style ;

  sh:property [
    sh:path wd:opacity ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
    sh:maxInclusive 1 ;
  ] ;

  sh:property [
    sh:path wd:fill ;
    sh:maxCount 1 ;
    sh:class wd:Paint ;
  ] ;

  sh:property [
    sh:path wd:stroke ;
    sh:maxCount 1 ;
    sh:class wd:Stroke ;
  ] ;

  sh:property [
    sh:path wd:typeStyle ;
    sh:maxCount 1 ;
    sh:class wd:TypographicStyle ;
  ] .

wd:PaintShape
  a sh:NodeShape ;
  sh:targetClass wd:Paint ;

  sh:property [
    sh:path wd:paintKind ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
  ] ;

  sh:property [
    sh:path wd:paintValue ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:string ;
  ] .

wd:StrokeShape
  a sh:NodeShape ;
  sh:targetClass wd:Stroke ;

  sh:property [
    sh:path wd:strokeWidth ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] .

wd:TypographicStyleShape
  a sh:NodeShape ;
  sh:targetClass wd:TypographicStyle ;

  sh:property [
    sh:path wd:typeface ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Typeface ;
  ] ;

  sh:property [
    sh:path wd:fontSize ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minExclusive 0 ;
  ] ;

  sh:property [
    sh:path wd:fontWeight ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
    sh:minInclusive 1 ;
  ] ;

  sh:property [
    sh:path wd:leading ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minExclusive 0 ;
  ] ;

  sh:property [
    sh:path wd:tracking ;
    sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
  ] .

#####################################################################
# PrincipleStatement
#####################################################################

wd:PrincipleStatementShape
  a sh:NodeShape ;
  sh:targetClass wd:PrincipleStatement ;

  sh:property [
    sh:path wd:principleType ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:Principle ;
  ] ;

  sh:property [
    sh:path wd:scope ;
    sh:minCount 1 ; sh:maxCount 1 ;
  ] ;

  sh:property [
    sh:path wd:participant ;
    sh:minCount 1 ;
    sh:class wd:ElementInstance ;
  ] .

#####################################################################
# END wd-core.shacl.ttl
#####################################################################

#####################################################################
# BEGIN wd-policy.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# Responsive/adaptive policy constraints (1.0.0)
#####################################################################

wd:CompositionPolicyAttachmentShape
  a sh:NodeShape ;
  sh:targetClass wd:Composition ;

  sh:property [
    sh:path wd:hasPolicy ;
    sh:class wd:Policy ;
  ] .

wd:PolicyShape
  a sh:NodeShape ;
  sh:targetClass wd:Policy ;

  sh:property [
    sh:path wd:appliesTo ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:or (
      [ sh:class wd:Composition ]
      [ sh:class wd:View ]
    ) ;
  ] ;

  sh:property [
    sh:path wd:hasCondition ;
    sh:minCount 1 ;
    sh:class wd:Condition ;
  ] ;

  sh:property [
    sh:path wd:hasAction ;
    sh:minCount 1 ;
    sh:class wd:Action ;
  ] ;

  sh:property [
    sh:path wd:priority ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
    sh:minInclusive 0 ;
  ] ;

  sh:property [
    sh:path wd:conflictStrategy ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:ConflictStrategy ;
    sh:in (
      wd:ErrorOnConflict
      wd:HigherPriorityWins
      wd:FirstMatchWins
    ) ;
  ] ;

  sh:property [
    sh:path wd:enabled ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:boolean ;
  ] ;

  # Duplicate priorities within the same appliesTo scope are not allowed in 1.0.0.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Policy priority MUST be unique within the same wd:appliesTo scope." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?other ?scope ?p
      WHERE {
        $this wd:appliesTo ?scope ;
              wd:priority ?p .
        ?other a wd:Policy ;
               wd:appliesTo ?scope ;
               wd:priority ?p .
        FILTER (?other != $this)
      }
    """ ;
  ] ;

  # Conflict strategy MUST be uniform within the same appliesTo scope.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "All policies in the same wd:appliesTo scope MUST use the same wd:conflictStrategy." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?other ?scope ?thisStrategy ?otherStrategy
      WHERE {
        $this wd:appliesTo ?scope ;
              wd:conflictStrategy ?thisStrategy .
        ?other a wd:Policy ;
               wd:appliesTo ?scope ;
               wd:conflictStrategy ?otherStrategy .
        FILTER (?other != $this)
        FILTER (?thisStrategy != ?otherStrategy)
      }
    """ ;
  ] .

wd:ConditionShape
  a sh:NodeShape ;
  sh:targetClass wd:Condition ;

  sh:property [
    sh:path wd:contextKey ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:ContextKey ;
    sh:in (
      wd:ViewportWidthPx
      wd:ViewportHeightPx
      wd:ViewportAspectRatio
      wd:ViewportOrientation
      wd:DeviceClass
      wd:ReducedMotionPreference
    ) ;
  ] ;

  sh:property [
    sh:path wd:operator ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:ComparisonOperator ;
    sh:in (
      wd:OpEq
      wd:OpNe
      wd:OpLt
      wd:OpLte
      wd:OpGt
      wd:OpGte
    ) ;
  ] ;

  # Exactly one typed comparison value.
  sh:xone (
    [ sh:property [ sh:path wd:conditionValueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path wd:conditionValueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
    [ sh:property [ sh:path wd:conditionValueString ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ]
    [ sh:property [ sh:path wd:conditionValueBoolean ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ]
  ) ;

  # Numeric operators require numeric condition values.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Numeric operators (OpLt/OpLte/OpGt/OpGte) require conditionValueDecimal or conditionValueInteger." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this
      WHERE {
        $this wd:operator ?op .
        FILTER (?op IN (wd:OpLt, wd:OpLte, wd:OpGt, wd:OpGte))
        FILTER NOT EXISTS { $this wd:conditionValueDecimal ?d . }
        FILTER NOT EXISTS { $this wd:conditionValueInteger ?i . }
      }
    """ ;
  ] ;

  # Boolean and string values are constrained to equality operators.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "conditionValueBoolean requires operator OpEq or OpNe." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this
      WHERE {
        $this wd:conditionValueBoolean ?b ;
              wd:operator ?op .
        FILTER (?op NOT IN (wd:OpEq, wd:OpNe))
      }
    """ ;
  ] ;

  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "conditionValueString requires operator OpEq or OpNe." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this
      WHERE {
        $this wd:conditionValueString ?s ;
              wd:operator ?op .
        FILTER (?op NOT IN (wd:OpEq, wd:OpNe))
      }
    """ ;
  ] .

wd:ActionShape
  a sh:NodeShape ;
  sh:targetClass wd:Action ;

  sh:property [
    sh:path wd:actionMode ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class wd:ActionMode ;
    sh:in (
      wd:ReplaceAll
      wd:Add
      wd:Remove
    ) ;
  ] ;

  sh:property [
    sh:path wd:targetNode ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
  ] ;

  sh:property [
    sh:path wd:targetProperty ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
  ] ;

  # Exactly one typed action value.
  sh:xone (
    [ sh:property [ sh:path wd:actionValueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path wd:actionValueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
    [ sh:property [ sh:path wd:actionValueString ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ]
    [ sh:property [ sh:path wd:actionValueBoolean ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ]
    [ sh:property [ sh:path wd:actionValueIRI ; sh:minCount 1 ; sh:maxCount 1 ; sh:nodeKind sh:IRI ] ]
  ) .

#####################################################################
# END wd-policy.shacl.ttl
#####################################################################

#####################################################################
# BEGIN wd-core-grid.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# Grid constraints (only defined here; not duplicated elsewhere)
#####################################################################

wd:GridSystemShape
  a sh:NodeShape ;
  sh:targetClass wd:GridSystem ;

  sh:property [
    sh:path wd:columnCount ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
    sh:minInclusive 1 ;
  ] ;

  sh:property [
    sh:path wd:rowCount ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
    sh:minInclusive 1 ;
  ] ;

  sh:property [
    sh:path wd:baselineGrid ;
    sh:maxCount 1 ;
    sh:class wd:BaselineGrid ;
  ] ;

  sh:property [
    sh:path wd:hasUnit ;
    sh:class wd:GridUnit ;
  ] .

wd:GridUnitShape
  a sh:NodeShape ;
  sh:targetClass wd:GridUnit ;
  sh:xone (
    [ sh:class wd:ColumnUnit ]
    [ sh:class wd:RowUnit ]
    [ sh:class wd:GutterUnit ]
  ) .

wd:BaselineGridShape
  a sh:NodeShape ;
  sh:targetClass wd:BaselineGrid ;

  sh:property [
    sh:path wd:baselineStep ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:decimal ;
    sh:minExclusive 0 ;
  ] .

#####################################################################
# END wd-core-grid.shacl.ttl
#####################################################################

#####################################################################
# BEGIN wd-core-figureground.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

#####################################################################
# Figureâ€“Ground constraints (only defined here; not duplicated elsewhere)
#####################################################################

wd:FigureGroundShape
  a sh:NodeShape ;
  sh:targetClass wd:FigureGroundStatement ;

  sh:property [
    sh:path wd:principleType ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:hasValue wd:FigureGround ;
  ] ;

  sh:property [
    sh:path wd:scope ;
    sh:minCount 1 ; sh:maxCount 1 ;
  ] ;

  sh:property [
    sh:path wd:participant ;
    sh:minCount 1 ;
    sh:class wd:ElementInstance ;
  ] ;

  sh:property [
    sh:path wd:foreground ;
    sh:minCount 1 ;
    sh:class wd:ElementInstance ;
  ] ;

  sh:property [
    sh:path wd:background ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class wd:ElementInstance ]
      [ sh:class wd:Region ]
    ) ;
  ] ;

  ###################################################################
  # foreground-implies-participant: every foreground must also be a participant
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:foreground element must also be a wd:participant of this FigureGroundStatement." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:foreground ?e .
        FILTER NOT EXISTS { $this wd:participant ?e . }
      }
    """ ;
  ] .

#####################################################################
# END wd-core-figureground.shacl.ttl
#####################################################################

#####################################################################
# BEGIN wd-core-closure.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

#####################################################################
# Ownership: every node of these classes must declare ownedBy exactly once
#####################################################################

wd:ElementInstanceOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:ElementInstance ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:RectOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Rect ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:StyleOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Style ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:PaintOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Paint ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:StrokeOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Stroke ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:TypographicStyleOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:TypographicStyle ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:TransformOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Transform ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:GridSystemOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:GridSystem ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:GridUnitOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:GridUnit ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:BaselineGridOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:BaselineGrid ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:PrincipleStatementOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:PrincipleStatement ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:RegionOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Region ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:LayerOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Layer ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:CanvasOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:Canvas ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

wd:GroupInstanceOwnershipShape
  a sh:NodeShape ;
  sh:targetClass wd:GroupInstance ;
  sh:property [ sh:path wd:ownedBy ; sh:minCount 1 ; sh:maxCount 1 ; sh:class wd:Composition ] .

#####################################################################
# END wd-core-closure.shacl.ttl
#####################################################################

#####################################################################
# BEGIN wd-core-closure-seal.shacl.ttl
#####################################################################

@prefix wd: <https://paperhat.dev/ns/wd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

#####################################################################
# wd-core-closure-seal.shacl.ttl
#
# Sealed Composition Graph Constraints (SHACL-SPARQL)
#
# Purpose:
# - enforce same-owner sealing for the full structural footprint of a
#   wd:Composition (closed-world, no cross-composition references)
# - enforce full reverse-reachability closure for every ownable structural
#   class using explicit structural-path constraints
#
# Notes:
# - Same-owner constraints require $this binding (SHACL-SPARQL).
# - Ownership-exactly-once constraints live in wd-core-closure.shacl.ttl.
#####################################################################

#####################################################################
# Composition sealing (same-owner invariants)
#####################################################################

wd:CompositionSealShape
  a sh:NodeShape ;
  sh:targetClass wd:Composition ;

  ###################################################################
  # hasCanvas: the Canvas referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "The wd:hasCanvas node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?c
      WHERE {
        $this wd:hasCanvas ?c .
        FILTER NOT EXISTS { ?c wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasElement: every ElementInstance referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasElement node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:hasElement ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.frame: every Rect referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:frame Rect referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:frame ?r .
        FILTER NOT EXISTS { ?r wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.style: every Style referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:style referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?s
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        FILTER NOT EXISTS { ?s wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.transform: every Transform referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:transform referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?t
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:transform ?t .
        FILTER NOT EXISTS { ?t wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.fill: every Paint referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:fill Paint referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:fill ?p .
        FILTER NOT EXISTS { ?p wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.stroke: every Stroke referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:stroke Stroke referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?k
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:stroke ?k .
        FILTER NOT EXISTS { ?k wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # style.typeStyle: every TypographicStyle referenced by a Style of an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:typeStyle TypographicStyle referenced by a Style in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?ts
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:style ?s .
        ?s wd:typeStyle ?ts .
        FILTER NOT EXISTS { ?ts wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasGrid: the GridSystem referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "If wd:hasGrid is present, the GridSystem must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        $this wd:hasGrid ?g .
        FILTER NOT EXISTS { ?g wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # grid.hasUnit: every GridUnit referenced by hasUnit must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasUnit GridUnit referenced by this Composition's GridSystem must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?u
      WHERE {
        $this wd:hasGrid ?g .
        ?g wd:hasUnit ?u .
        FILTER NOT EXISTS { ?u wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # grid.baselineGrid: if a GridSystem has baselineGrid, the BaselineGrid must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "If a GridSystem has wd:baselineGrid, the BaselineGrid must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?b
      WHERE {
        $this wd:hasGrid ?g .
        ?g wd:baselineGrid ?b .
        FILTER NOT EXISTS { ?b wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # expresses: every PrincipleStatement linked by expresses must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:expresses PrincipleStatement must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        $this wd:expresses ?p .
        FILTER NOT EXISTS { ?p wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # participant: every participant of an expressed PrincipleStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:participant in a PrincipleStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:expresses ?p .
        ?p wd:participant ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # foreground: every foreground element of an expressed FigureGroundStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:foreground element in a FigureGroundStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        $this wd:expresses ?p .
        ?p a wd:FigureGroundStatement .
        ?p wd:foreground ?e .
        FILTER NOT EXISTS { ?e wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # background: every background value of an expressed FigureGroundStatement must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:background value in a FigureGroundStatement expressed by this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?x
      WHERE {
        $this wd:expresses ?p .
        ?p a wd:FigureGroundStatement .
        ?p wd:background ?x .
        FILTER NOT EXISTS { ?x wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # group: every GroupInstance referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:group GroupInstance referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:group ?g .
        FILTER NOT EXISTS { ?g wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasRegion: every Region referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasRegion node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        $this wd:hasRegion ?r .
        FILTER NOT EXISTS { ?r wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # hasLayer: every Layer referenced by this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:hasLayer node must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        $this wd:hasLayer ?l .
        FILTER NOT EXISTS { ?l wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # element.layer: every Layer referenced by an ElementInstance in this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:layer referenced by an ElementInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:layer ?l .
        FILTER NOT EXISTS { ?l wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # member: every ElementInstance referenced by a GroupInstance reachable from this Composition must be ownedBy this Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every wd:member referenced by a GroupInstance in this Composition must be ownedBy this Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?m
      WHERE {
        $this wd:hasElement ?e .
        ?e wd:group ?g .
        ?g wd:member ?m .
        FILTER NOT EXISTS { ?m wd:ownedBy $this . }
      }
    """ ;
  ] ;

  ###################################################################
  # Orphaned PrincipleStatements: no owned PrincipleStatement may exist that is not linked by expresses from its owning Composition
  ###################################################################
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "No PrincipleStatement ownedBy this Composition may be orphaned (must be linked by wd:expresses)." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        ?p a wd:PrincipleStatement .
        ?p wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:expresses ?p . }
      }
    """ ;
  ] ;

  ###################################################################
  # Reverse reachability closure: every owned node class must be reachable
  # from its owning Composition through an allowed structural path.
  ###################################################################

  # Canvas
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Canvas must be reachable via wd:hasCanvas from its owning Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?c
      WHERE {
        ?c a wd:Canvas ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasCanvas ?c . }
      }
    """ ;
  ] ;

  # ElementInstance
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:ElementInstance must be reachable via wd:hasElement or via GroupInstance membership rooted at wd:hasElement." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?e
      WHERE {
        ?e a wd:ElementInstance ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasElement ?e . }
        FILTER NOT EXISTS {
          $this wd:hasElement ?root .
          ?root wd:group ?g .
          ?g wd:member ?e .
        }
      }
    """ ;
  ] ;

  # Rect
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Rect must be reachable via wd:frame from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        ?r a wd:Rect ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:frame ?r .
        }
      }
    """ ;
  ] ;

  # Style
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Style must be reachable via wd:style from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?s
      WHERE {
        ?s a wd:Style ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:style ?s .
        }
      }
    """ ;
  ] ;

  # Paint
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Paint must be reachable via wd:fill from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?p
      WHERE {
        ?p a wd:Paint ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:fill ?p .
        }
      }
    """ ;
  ] ;

  # Stroke
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Stroke must be reachable via wd:stroke from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?k
      WHERE {
        ?k a wd:Stroke ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:stroke ?k .
        }
      }
    """ ;
  ] ;

  # TypographicStyle
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:TypographicStyle must be reachable via wd:typeStyle from an owned wd:Style." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?ts
      WHERE {
        ?ts a wd:TypographicStyle ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?s a wd:Style ; wd:ownedBy $this ; wd:typeStyle ?ts .
        }
      }
    """ ;
  ] ;

  # Transform
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Transform must be reachable via wd:transform from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?t
      WHERE {
        ?t a wd:Transform ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:transform ?t .
        }
      }
    """ ;
  ] ;

  # GroupInstance
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GroupInstance must be reachable via wd:group from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        ?g a wd:GroupInstance ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:group ?g .
        }
      }
    """ ;
  ] ;

  # GridSystem
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GridSystem must be reachable via wd:hasGrid from its owning Composition." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?g
      WHERE {
        ?g a wd:GridSystem ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasGrid ?g . }
      }
    """ ;
  ] ;

  # GridUnit
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:GridUnit must be reachable via wd:hasUnit from an owned wd:GridSystem." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?u
      WHERE {
        ?u a wd:GridUnit ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?g a wd:GridSystem ; wd:ownedBy $this ; wd:hasUnit ?u .
        }
      }
    """ ;
  ] ;

  # BaselineGrid
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:BaselineGrid must be reachable via wd:baselineGrid from an owned wd:GridSystem." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?b
      WHERE {
        ?b a wd:BaselineGrid ; wd:ownedBy $this .
        FILTER NOT EXISTS {
          ?g a wd:GridSystem ; wd:ownedBy $this ; wd:baselineGrid ?b .
        }
      }
    """ ;
  ] ;

  # Region
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Region must be reachable via wd:hasRegion or as wd:background in an expressed wd:FigureGroundStatement." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?r
      WHERE {
        ?r a wd:Region ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasRegion ?r . }
        FILTER NOT EXISTS {
          $this wd:expresses ?p .
          ?p a wd:FigureGroundStatement .
          ?p wd:background ?r .
        }
      }
    """ ;
  ] ;

  # Layer
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Every owned wd:Layer must be reachable via wd:hasLayer or via wd:layer from an owned wd:ElementInstance." ;
    sh:select """
      PREFIX wd: <https://paperhat.dev/ns/wd#>
      SELECT $this ?l
      WHERE {
        ?l a wd:Layer ; wd:ownedBy $this .
        FILTER NOT EXISTS { $this wd:hasLayer ?l . }
        FILTER NOT EXISTS {
          ?e a wd:ElementInstance ; wd:ownedBy $this ; wd:layer ?l .
        }
      }
    """ ;
  ] .

#####################################################################
# Owned node whitelist (enforceable closure boundary)
#####################################################################

wd:OwnedNodeClassWhitelistShape
  a sh:NodeShape ;
  sh:targetSubjectsOf wd:ownedBy ;

  sh:or (
    [ sh:class wd:ElementInstance ]
    [ sh:class wd:Rect ]
    [ sh:class wd:Style ]
    [ sh:class wd:Paint ]
    [ sh:class wd:Stroke ]
    [ sh:class wd:TypographicStyle ]
    [ sh:class wd:Transform ]
    [ sh:class wd:GroupInstance ]
    [ sh:class wd:GridSystem ]
    [ sh:class wd:GridUnit ]
    [ sh:class wd:BaselineGrid ]
    [ sh:class wd:PrincipleStatement ]
    [ sh:class wd:Region ]
    [ sh:class wd:Layer ]
    [ sh:class wd:Canvas ]
  ) .

#####################################################################
# END wd-core-closure-seal.shacl.ttl
#####################################################################
