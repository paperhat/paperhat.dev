@prefix gd: <https://paperhat.dev/ns/gd#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#####################################################################
# Responsive/adaptive policy constraints (1.0.0)
#####################################################################

gd:CompositionPolicyAttachmentShape
  a sh:NodeShape ;
  sh:targetClass gd:Composition ;

  sh:property [
    sh:path gd:hasPolicy ;
    sh:class gd:Policy ;
  ] .

gd:PolicyShape
  a sh:NodeShape ;
  sh:targetClass gd:Policy ;

  sh:property [
    sh:path gd:appliesTo ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:or (
      [ sh:class gd:Composition ]
      [ sh:class gd:View ]
    ) ;
  ] ;

  sh:property [
    sh:path gd:hasCondition ;
    sh:minCount 1 ;
    sh:class gd:Condition ;
  ] ;

  sh:property [
    sh:path gd:hasAction ;
    sh:minCount 1 ;
    sh:class gd:Action ;
  ] ;

  sh:property [
    sh:path gd:priority ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:integer ;
    sh:minInclusive 0 ;
  ] ;

  sh:property [
    sh:path gd:conflictStrategy ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gd:ConflictStrategy ;
    sh:in (
      gd:ErrorOnConflict
      gd:HigherPriorityWins
      gd:FirstMatchWins
    ) ;
  ] ;

  sh:property [
    sh:path gd:enabled ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:datatype xsd:boolean ;
  ] ;

  # Duplicate priorities within the same appliesTo scope are not allowed in 1.0.0.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Policy priority MUST be unique within the same gd:appliesTo scope." ;
    sh:select """
      PREFIX gd: <https://paperhat.dev/ns/gd#>
      SELECT $this ?other ?scope ?p
      WHERE {
        $this gd:appliesTo ?scope ;
              gd:priority ?p .
        ?other a gd:Policy ;
               gd:appliesTo ?scope ;
               gd:priority ?p .
        FILTER (?other != $this)
      }
    """ ;
  ] ;

  # Conflict strategy MUST be uniform within the same appliesTo scope.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "All policies in the same gd:appliesTo scope MUST use the same gd:conflictStrategy." ;
    sh:select """
      PREFIX gd: <https://paperhat.dev/ns/gd#>
      SELECT $this ?other ?scope ?thisStrategy ?otherStrategy
      WHERE {
        $this gd:appliesTo ?scope ;
              gd:conflictStrategy ?thisStrategy .
        ?other a gd:Policy ;
               gd:appliesTo ?scope ;
               gd:conflictStrategy ?otherStrategy .
        FILTER (?other != $this)
        FILTER (?thisStrategy != ?otherStrategy)
      }
    """ ;
  ] .

gd:ConditionShape
  a sh:NodeShape ;
  sh:targetClass gd:Condition ;

  sh:property [
    sh:path gd:contextKey ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gd:ContextKey ;
    sh:in (
      gd:ViewportWidthPx
      gd:ViewportHeightPx
      gd:ViewportAspectRatio
      gd:ViewportOrientation
      gd:DeviceClass
      gd:ReducedMotionPreference
    ) ;
  ] ;

  sh:property [
    sh:path gd:operator ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gd:ComparisonOperator ;
    sh:in (
      gd:OpEq
      gd:OpNe
      gd:OpLt
      gd:OpLte
      gd:OpGt
      gd:OpGte
    ) ;
  ] ;

  # Exactly one typed comparison value.
  sh:xone (
    [ sh:property [ sh:path gd:conditionValueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path gd:conditionValueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
    [ sh:property [ sh:path gd:conditionValueString ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ]
    [ sh:property [ sh:path gd:conditionValueBoolean ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ]
  ) ;

  # Numeric operators require numeric condition values.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Numeric operators (OpLt/OpLte/OpGt/OpGte) require conditionValueDecimal or conditionValueInteger." ;
    sh:select """
      PREFIX gd: <https://paperhat.dev/ns/gd#>
      SELECT $this
      WHERE {
        $this gd:operator ?op .
        FILTER (?op IN (gd:OpLt, gd:OpLte, gd:OpGt, gd:OpGte))
        FILTER NOT EXISTS { $this gd:conditionValueDecimal ?d . }
        FILTER NOT EXISTS { $this gd:conditionValueInteger ?i . }
      }
    """ ;
  ] ;

  # Boolean and string values are constrained to equality operators.
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "conditionValueBoolean requires operator OpEq or OpNe." ;
    sh:select """
      PREFIX gd: <https://paperhat.dev/ns/gd#>
      SELECT $this
      WHERE {
        $this gd:conditionValueBoolean ?b ;
              gd:operator ?op .
        FILTER (?op NOT IN (gd:OpEq, gd:OpNe))
      }
    """ ;
  ] ;

  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "conditionValueString requires operator OpEq or OpNe." ;
    sh:select """
      PREFIX gd: <https://paperhat.dev/ns/gd#>
      SELECT $this
      WHERE {
        $this gd:conditionValueString ?s ;
              gd:operator ?op .
        FILTER (?op NOT IN (gd:OpEq, gd:OpNe))
      }
    """ ;
  ] .

gd:ActionShape
  a sh:NodeShape ;
  sh:targetClass gd:Action ;

  sh:property [
    sh:path gd:actionMode ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:class gd:ActionMode ;
    sh:in (
      gd:ReplaceAll
      gd:Add
      gd:Remove
    ) ;
  ] ;

  sh:property [
    sh:path gd:targetNode ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
  ] ;

  sh:property [
    sh:path gd:targetProperty ;
    sh:minCount 1 ; sh:maxCount 1 ;
    sh:nodeKind sh:IRI ;
  ] ;

  # Exactly one typed action value.
  sh:xone (
    [ sh:property [ sh:path gd:actionValueDecimal ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ] ]
    [ sh:property [ sh:path gd:actionValueInteger ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:integer ] ]
    [ sh:property [ sh:path gd:actionValueString ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ]
    [ sh:property [ sh:path gd:actionValueBoolean ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:boolean ] ]
    [ sh:property [ sh:path gd:actionValueIRI ; sh:minCount 1 ; sh:maxCount 1 ; sh:nodeKind sh:IRI ] ]
  ) .
